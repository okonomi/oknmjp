---
layout: "../../layouts/BlogPost.astro"
title: "webpackerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‹railsã‚¢ãƒ—ãƒªã§å˜ç´”ã«assets:precompileã‚’å®Ÿè¡Œã—ãŸã„"
pubDate: "2021-06-29 12:19"
---
webpackerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‹ã¨`assets:precompile`ã§webpackerã®å‡¦ç†ã‚‚å‹•ãã€‚

å˜ç´”ã«`assets:precompile`ã ã‘å‹•ã‹ã—ãŸã‹ã£ãŸã®ã§æ–¹æ³•ãŒãªã„ã‹èª¿ã¹ãŸã€‚

ã“ã‚Œã§ã„ã‘ãŸã€‚

```
rm bin/yarn
WEBPACKER_PRECOMPILE=false bin/rails assets:precompile
```

ç¢ºèªã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³:

- rails 6.1.4
- webpacker 5.4.0

ä»¥ä¸‹èª¿æŸ»ãƒ­ã‚°ã€‚

æ™®é€šã«å®Ÿè¡Œã—ã¦ã¿ã‚‹:

```
â¯ bin/rails assets:precompile
yarn install v1.22.10
[1/4] ğŸ” Resolving packages...
success Already up-to-date.
âœ¨ Done in 0.19s.
Compiling...
Compiled all packs in /Users/okonomi/src/local/rails-webpacker-sandbox/public/packs
Hash: e4cb1aa40fed2663ee2c
Version: webpack 4.46.0
Time: 446ms
Built at: 2021/06/29 21:03:08
                                        Asset Size Chunks Chunk Names
       js/application-c3e3aae48c4c321181e9.js 69.4 KiB 0 [emitted] [immutable] application
    js/application-c3e3aae48c4c321181e9.js.br 15.4 KiB [emitted]
    js/application-c3e3aae48c4c321181e9.js.gz 17.8 KiB [emitted]
   js/application-c3e3aae48c4c321181e9.js.map 205 KiB 0 [emitted] [dev] application
js/application-c3e3aae48c4c321181e9.js.map.br 43.8 KiB [emitted]
js/application-c3e3aae48c4c321181e9.js.map.gz 50.9 KiB [emitted]
                                manifest.json 364 bytes [emitted]
                             manifest.json.br 133 bytes [emitted]
                             manifest.json.gz 142 bytes [emitted]
Entrypoint application = js/application-c3e3aae48c4c321181e9.js js/application-c3e3aae48c4c321181e9.js.map
[0] (webpack)/buildin/module.js 552 bytes {0} [built]
[4] ./app/javascript/packs/application.js 480 bytes {0} [built]
[5] ./app/javascript/channels/index.js 205 bytes {0} [built]
[6] ./app/javascript/channels sync _channel\.js$ 160 bytes {0} [built]
    + 3 hidden modules
```

yarn installã®ã‚ã¨webpack compileãŒå‹•ã„ã¦ã‚‹ã€‚

ã©ã‚“ãªrakeã‚¿ã‚¹ã‚¯ãŒå‹•ã„ã¦ã‚‹ç¢ºèªã™ã‚‹:

```
â¯ bin/rails assets:precompile --trace
** Invoke assets:precompile (first_time)
** Invoke assets:environment (first_time)
** Execute assets:environment
** Invoke environment (first_time)
** Execute environment
** Invoke yarn:install (first_time)
** Execute yarn:install
yarn install v1.22.10
[1/4] ğŸ” Resolving packages...
success Already up-to-date.
âœ¨ Done in 0.19s.
** Execute assets:precompile
** Invoke webpacker:compile (first_time)
** Invoke webpacker:verify_install (first_time)
** Invoke webpacker:check_node (first_time)
** Execute webpacker:check_node
** Invoke webpacker:check_yarn (first_time)
** Execute webpacker:check_yarn
** Invoke webpacker:check_binstubs (first_time)
** Execute webpacker:check_binstubs
** Execute webpacker:verify_install
** Invoke environment
** Execute webpacker:compile
Everything's up-to-date. Nothing to do
```

`yarn:install`ã¨ã‹webpackerç³»ã®ã‚¿ã‚¹ã‚¯ãŒå‹•ã„ã¦ã‚‹ã€‚

webpackerã®ã‚¿ã‚¹ã‚¯ã¯ç’°å¢ƒå¤‰æ•°ã§ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ã€‚

[https://github.com/rails/webpacker/blob/master/CHANGELOG.md#added-gem-1](https://github.com/rails/webpacker/blob/master/CHANGELOG.md#added-gem-1)

```
â¯ env WEBPACKER_PRECOMPILE=false bin/rails assets:precompile --trace
** Invoke assets:precompile (first_time)
** Invoke assets:environment (first_time)
** Execute assets:environment
** Invoke environment (first_time)
** Execute environment
** Invoke yarn:install (first_time)
** Execute yarn:install
yarn install v1.22.10
[1/4] ğŸ” Resolving packages...
success Already up-to-date.
âœ¨ Done **in** 0.19s.
** Execute assets:precompile
```

`yarn:install`ãŒã©ã“ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã®ã‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢:

```
â¯ grep -r "yarn:install" .bundle/ruby/3.0.0/gems
.bundle/ruby/3.0.0/gems/railties-6.1.4/lib/rails/tasks/yarn.rake: Rake::Task["assets:precompile"].enhance ["yarn:install"]
.bundle/ruby/3.0.0/gems/webpacker-5.4.0/docs/engines.md: # yarn:install was added in Rails 5.1
.bundle/ruby/3.0.0/gems/webpacker-5.4.0/lib/tasks/webpacker/compile.rake: # yarn:install was added in Rails 5.1
```

railtiesã®`lib/rails/tasks/yarn.rake`ã‚’è¦‹ã‚‹:

```
# Run Yarn prior to Sprockets assets precompilation, so dependencies are available for use. **if** Rake::Task.task_defined?("assets:precompile") && File.exist?(Rails.root.join("bin", "yarn"))
  Rake::Task["assets:precompile"].enhance ["yarn:install"] **end**
```

`assets:precompile`ã‚¿ã‚¹ã‚¯ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã¨`bin/yarn`ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«`yarn:install`ãŒå‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ã€‚

`bin/yarn`ã‚’æ¶ˆã—ã¦ã¿ã‚‹:

```
â¯ rm bin/yarn
â¯ WEBPACKER_PRECOMPILE=false bin/rails assets:precompile --trace
** Invoke assets:precompile (first_time)
** Invoke assets:environment (first_time)
** Execute assets:environment
** Invoke environment (first_time)
** Execute environment
** Execute assets:precompile
```

`yarn:install`ãŒå‘¼ã°ã‚Œãªããªã£ãŸï¼

# ã¾ã¨ã‚

webpackerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‹railsã‚¢ãƒ—ãƒªã§å˜ç´”ã«`assets:precompile`ã ã‘å‹•ã‹ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹:

- `bin/yarn`ã‚’å‰Šé™¤ã™ã‚‹
- ç’°å¢ƒå¤‰æ•°`WEBPACKER_PRECOMPILE=false`ã‚’è¨­å®šã™ã‚‹

# å‚™è€ƒ

rails 6.0ã ã¨`bin/yarn`ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¯ãªã‹ã£ãŸ:

[https://github.com/rails/rails/blob/6-0-stable/railties/lib/rails/tasks/yarn.rake](https://github.com/rails/rails/blob/6-0-stable/railties/lib/rails/tasks/yarn.rake)

```
# Run Yarn prior to Sprockets assets precompilation, so dependencies are available for use.
if Rake::Task.task_defined?("assets:precompile")
  Rake::Task["assets:precompile"].enhance ["yarn:install"]
end
```
